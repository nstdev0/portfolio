---
import { getCollection } from "astro:content";
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const rawProjects = await getCollection("projects");
const projects = rawProjects.sort((a, b) => a.data.order - b.data.order);
---

<section id="projects" class="py-15">
  <div class="max-w-7xl mx-auto px-6">
    <div class="flex justify-between items-end mb-16">
      <div>
        <h2
          class="text-primary text-sm font-bold tracking-widest mb-2 uppercase"
        >
          {t("projects.subtitle")}
        </h2>
        <h3 class="text-4xl md:text-5xl font-bold">
          {t("projects.title")}
          <span class="text-muted">{t("projects.title.span")}</span>
        </h3>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      {
        projects.map((project) => (
          <article class="group relative bg-surfaceHighlight rounded-2xl overflow-hidden border border-text/5 hover:border-primary/50 transition-all duration-500">
            <div class="aspect-video bg-surface relative overflow-hidden group/image">
              <img
                src={project.data.img}
                alt={project.data.title[lang]}
                class="w-full h-full object-cover transition-transform duration-700 group-hover/image:scale-105"
              />

              <div class="absolute inset-0 bg-background/50 opacity-0 group-hover/image:opacity-100 transition-opacity duration-300 flex items-center justify-center z-10">
                {project.data.video && (
                  <button
                    data-video={project.data.video}
                    class="play-button flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-full font-medium transform translate-y-4 group-hover/image:translate-y-0 transition-all duration-300 hover:scale-105 hover:bg-primary/90"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                      class="w-5 h-5"
                    >
                      <title>play-circle</title>
                      <path
                        fill-rule="evenodd"
                        d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm14.024-.983a1.125 1.125 0 0 1 0 1.966l-5.603 3.113A1.125 1.125 0 0 1 9 15.113V8.887c0-.857.921-1.4 1.671-.983l5.603 3.113Z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    {t("projects.playDemo")}
                  </button>
                )}
              </div>

              <div class="absolute bottom-0 left-0 right-0 p-6 z-20 bg-linear-to-t from-background/80 to-transparent">
                <div class="flex gap-2 mb-3">
                  {project.data.tags.map((tag: string) => (
                    <span class="px-3 py-1 text-xs bg-text/10 backdrop-blur-md rounded-full border border-text/10 text-text/90">
                      {tag}
                    </span>
                  ))}
                </div>
                <div class="flex justify-between items-end">
                  <div>
                    <a
                      href={project.data.link}
                      target="_blank"
                      class="text-2xl font-bold mb-2 text-text group-hover:text-primary transition-colors inline-block"
                    >
                      {project.data.title[lang]}
                    </a>
                    <p class="text-sm text-muted line-clamp-2 max-w-sm">
                      {project.data.desc[lang]}
                    </p>
                  </div>
                  <a
                    href={project.data.link}
                    target="_blank"
                    class="p-2 bg-text/10 rounded-full hover:bg-primary hover:text-white transition-colors text-text"
                    aria-label={t("projects.visitSite")}
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="size-5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"
                      />
                    </svg>
                  </a>
                </div>
              </div>
            </div>
          </article>
        ))
      }
    </div>
  </div>

  <!-- Video Modal -->
  <div
    id="video-modal"
    class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-300"
  >
    <!-- Backdrop -->
    <div
      class="absolute inset-0 bg-background/90 backdrop-blur-sm"
      id="modal-backdrop"
    >
    </div>

    <!-- Modal Content -->
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div
        class="relative w-full max-w-5xl aspect-video bg-black rounded-xl overflow-hidden shadow-2xl scale-95 transition-transform duration-300"
        id="modal-content"
      >
        <button
          id="close-modal"
          class="absolute top-4 right-4 z-10 text-text/70 hover:text-text bg-background/50 hover:bg-background/80 rounded-full p-2 transition-all"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <iframe
          id="video-frame"
          class="w-full h-full"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen></iframe>
      </div>
    </div>
  </div>
</section>

<script>
  function setupVideoModal() {
    const modal = document.getElementById("video-modal");
    const backdrop = document.getElementById("modal-backdrop");
    const closeBtn = document.getElementById("close-modal");
    const iframe = document.getElementById("video-frame") as HTMLIFrameElement;
    const modalContent = document.getElementById("modal-content");
    const playButtons = document.querySelectorAll(".play-button");

    if (!modal || !iframe || !backdrop || !closeBtn || !modalContent) return;

    function openModal(videoUrl: string) {
      modal?.classList.remove("hidden");
      void modal?.offsetWidth;
      modal?.classList.remove("opacity-0");
      modalContent?.classList.remove("scale-95");
      modalContent?.classList.add("scale-100");
      iframe.src = videoUrl;
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      modal?.classList.add("opacity-0");
      modalContent?.classList.add("scale-95");
      modalContent?.classList.remove("scale-100");

      setTimeout(() => {
        modal?.classList.add("hidden");
        iframe.src = "";
        document.body.style.overflow = "";
      }, 300);
    }

    playButtons.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const videoUrl = (btn as HTMLElement).dataset.video;
        if (videoUrl) openModal(videoUrl);
      });
    });

    closeBtn.addEventListener("click", closeModal);
    backdrop.addEventListener("click", closeModal);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !modal.classList.contains("hidden")) {
        closeModal();
      }
    });
  }

  setupVideoModal();
  document.addEventListener("astro:page-load", setupVideoModal);
</script>
